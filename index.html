<!doctype html>
<html lang="pt-PT" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EIP – Checklists de Viaturas (Bootstrap + Firebase)</title>

  <!-- ===================== Bootstrap & Libs ===================== -->
  <link rel="stylesheet" href="bootstrap.min.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="bootstrap.min.js"></script>
  <!-- Exportação para Excel (SheetJS) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <!-- ===================== Firebase (compat) ===================== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ===================== Estilos ===================== -->
  <style>
    :root{
      --accent:#003366; --accent-dark:#002244; --muted:#6b7280; --page-bg:#f7f7f9;
      --status-ok:#10b981; --status-missing:#ef4444; --status-damaged:#f59e0b;
      --bs-primary:var(--accent); --bs-primary-rgb:0,51,102; --bs-secondary:#4b5563; --bs-body-bg:#fff;
    }
    body{background:linear-gradient(180deg,#fbfbfc,#f0f2f5)}
    .soft-card{background:#fff;border:1px solid rgba(15,23,42,.06);border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    .badge-light-type{background:#dbeafe;color:#1e40af}.badge-heavy-type{background:#fee2e2;color:#991b1b}
    .status-pill{min-width:120px}.status-oper{background:var(--status-ok)!important}.status-inop{background:var(--status-missing)!important}
    .home-hero{height:clamp(220px,30vw,360px);display:flex;align-items:center;justify-content:center;background:#fff}
    .home-hero img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    table.table tbody tr:hover{background:#f9fafb}

    /* ===== Mobile first tweaks ===== */
    @media (max-width: 576px) {
      .soft-card { border-radius: 10px; }
      .status-pill { min-width: auto; padding: .375rem .5rem; }
      .navbar-brand { font-size: 0.95rem; }
      .table { font-size: .95rem; }
      #view-viatura { padding-bottom: 4.5rem; } /* espaço p/ actionbar mobile */
    }

    /* Barra de ações fixa no detalhe da viatura (só mobile) */
    .mobile-actionbar {
      position: sticky;
      bottom: calc(.5rem + env(safe-area-inset-bottom, 0));
      left: 0; right: 0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      padding: .5rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15,23,42,.15);
      display: flex;
      gap: .5rem;
      z-index: 1030;
    }
    .mobile-actionbar .btn { flex: 1; }

    /* Print: só a área #print-section */
    @media print{body *{visibility:hidden}#print-section, #print-section *{visibility:visible}#print-section{position:absolute;inset:0;width:100%}.no-print{display:none!important}}
  </style>
</head>
<body>
  <!-- ====================== NAVBAR ======================= -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(90deg, var(--accent), #00509e)">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">EQUIPA DE INTERVENÇÃO PERMANENTE</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="mainNav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="#" data-view="home">Início</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-view="viaturas">Viaturas</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-view="aricas">ARICAS</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-view="planeamento">Planeamento</a></li>
          <li class="nav-item"><button id="btnPrint" class="btn btn-sm btn-secondary ms-lg-3 no-print">Imprimir</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ======================== CONTEÚDO =========================== -->
  <main class="container py-4">

    <!-- ========== HOME ========== -->
    <section id="view-home" class="soft-card p-4 mb-4">
      <div class="row g-4 align-items-center">
        <div class="col-lg-8">
          <h2 class="h4 mb-1">Bem-vindo</h2>
          <p class="text-secondary mb-0">Gestão rápida das viaturas, ARICAS e planeamento. Usa o topo para navegar.</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <button class="btn btn-primary me-2" data-view="viaturas">Ver Viaturas</button>
          <button class="btn btn-outline-primary" data-view="aricas">Ver ARICAS</button>
        </div>
      </div>

      <!-- Imagem home (troca o src pelo teu ficheiro) -->
      <div class="soft-card mt-3 p-2">
        <div class="home-hero">
          <img src="Equipa-de-Intervencao-Permanente-Bombeiros.png" alt="Imagem de destaque">
        </div>
      </div>

      <!-- KPIs Viaturas -->
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 mt-1">
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Total de Viaturas</div><div id="kpiTotal" class="display-6 fw-bold">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Operacionais</div><div id="kpiOper" class="display-6 fw-bold text-success">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Inoperacionais</div><div id="kpiInop" class="display-6 fw-bold text-danger">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">ARICAS</div><div id="kpiAricas" class="display-6 fw-bold">0</div></div></div>
      </div>

      <!-- KPIs Ferramentas -->
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 mt-1">
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Total de Ferramentas</div><div id="kpiFerrTotal" class="display-6 fw-bold">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Ferramentas OK</div><div id="kpiFerrOK" class="display-6 fw-bold text-success">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Ferramentas em Falta</div><div id="kpiFerrFalta" class="display-6 fw-bold text-danger">0</div></div></div>
        <div class="col"><div class="soft-card p-3 h-100"><div class="text-secondary small">Ferramentas Danificadas</div><div id="kpiFerrDan" class="display-6 fw-bold text-warning">0</div></div></div>
      </div>
    </section>

    <!-- ========== VIATURAS (lista) ========== -->
    <section id="view-viaturas" class="d-none">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
        <h2 class="h4 mb-0">Viaturas</h2>
        <div class="d-flex gap-2 flex-wrap">
          <input id="searchViaturas" class="form-control flex-grow-1" type="search" placeholder="Pesquisar…" />
          <button id="btnAddViatura" class="btn btn-primary">Adicionar</button>
          <button id="btnExportViaturas" class="btn btn-outline-secondary">Exportar Excel</button>
        </div>
      </div>
      <div id="gridViaturas" class="row g-3"></div>
    </section>

    <!-- ========== VIATURA (detalhe) ========== -->
    <section id="view-viatura" class="d-none">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <button class="btn btn-link text-decoration-none" data-view="viaturas">← Voltar</button>
        <!-- botões desktop -->
        <div class="d-none d-sm-flex gap-2">
          <button id="btnAddFerramenta" class="btn btn-primary">Adicionar Ferramenta</button>
          <button id="btnExportFerramentas" class="btn btn-outline-secondary">Exportar Excel</button>
          <button id="btnToggleGroupFerr" class="btn btn-outline-secondary">Desagrupar</button>
        </div>
      </div>

      <div class="soft-card p-3 mb-3">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
          <div>
            <h3 id="detalheTitulo" class="h5 mb-1">Viatura</h3>
            <div id="detalheMeta" class="text-secondary small">Tipo • Matrícula</div>
          </div>
          <div class="btn-group" role="group" aria-label="Estado da viatura">
            <button id="btnEstadoOper" class="btn btn-success status-pill">Operacional</button>
            <button id="btnEstadoInop" class="btn btn-danger status-pill">Inoperacional</button>
          </div>
        </div>
      </div>

      <!-- action bar mobile -->
      <div class="mobile-actionbar d-sm-none">
        <button id="fabAddFerr" class="btn btn-primary btn-sm">Adicionar</button>
        <button id="fabGroupFerr" class="btn btn-outline-secondary btn-sm">Desagrupar</button>
        <button id="fabExportFerr" class="btn btn-outline-secondary btn-sm">Exportar</button>
      </div>

      <!-- Ferramentas -->
      <div class="soft-card p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 38px;">#</th>
                <th>Ferramenta</th>
                <th style="width: 120px;">Qtd</th>
                <th style="width: 180px;">Estado</th>
                <th style="width: 180px;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyFerramentas"></tbody>
          </table>
        </div>
      </div>

      <!-- Checklist diário -->
      <div class="soft-card p-3 mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="h6 mb-0">Checklist diário</h4>
          <div class="d-flex gap-2 flex-wrap">
            <button id="btnAddChecklist" class="btn btn-sm btn-primary">Novo registo</button>
            <button id="btnExportChecklists" class="btn btn-sm btn-outline-secondary">Exportar Excel</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 140px;">Data</th>
                <th style="width: 120px;">Kms</th>
                <th style="width: 120px;">Limpo</th>
                <th style="width: 120px;">Equipa</th>
                <th style="width: 170px;">Ferr.</th>
                <th>Observações</th>
                <th style="width: 220px;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyChecklists"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== ARICAS ========== -->
    <section id="view-aricas" class="d-none">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
        <h2 class="h4 mb-0">ARICAS</h2>
        <div class="d-flex gap-2">
          <button id="btnAddArica" class="btn btn-primary">Adicionar</button>
          <button id="btnExportAricas" class="btn btn-outline-secondary">Exportar Excel</button>
        </div>
      </div>

      <div class="soft-card p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 42px;">#</th>
                <th>Designação</th>
                <th>Localização</th>
                <th class="d-none d-md-table-cell" style="width:170px;">Prova hidráulica</th>
                <th class="d-none d-md-table-cell" style="width:170px;">Validade</th>
                <th style="width:150px;">Estado</th>
                <th style="width:140px;">BAR</th>
                <th style="width:160px;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyAricas"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== PLANEAMENTO ========== -->
    <section id="view-planeamento" class="d-none">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
        <h2 class="h4 mb-0">Planeamento</h2>
        <div class="d-flex gap-2">
          <input id="searchPlaneamento" class="form-control" type="search" placeholder="Pesquisar observações…" style="max-width: 280px;" />
          <button id="btnAddPlano" class="btn btn-primary">Adicionar</button>
          <button id="btnExportPlaneamento" class="btn btn-outline-secondary">Exportar Excel</button>
        </div>
      </div>

      <div class="soft-card p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 42px;">#</th>
                <th>Observação</th>
                <th style="width: 180px;">Estado</th>
                <th style="width: 180px;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyPlaneamento"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Área de impressão -->
    <section id="print-section" class="d-none"></section>
  </main>

  <!-- =========================== MODAIS ========================== -->
  <div class="modal fade" id="modalForm" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalFormTitle" class="modal-title">Título</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formGeneric" class="row g-3"><!-- campos injetados via JS --></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
          <button id="modalSave" type="button" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalConfirm" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalConfirmMsg">Tens a certeza?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="modalConfirmYes" type="button" class="btn btn-danger">Sim, continuar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================ SCRIPT ========================= -->
  <script>
    // =============================================================
    // =============== DADOS & ARMAZENAMENTO LOCAL =================
    // =============================================================
    const DB_KEY = 'eip_bootstrap_db_v3';
    const dbDefault = {
      viaturas: [
        { id: cryptoRandom(), nome: 'VUCI 01', tipo: 'pesada', matricula: 'AA-00-AA', estado: 'operacional',
          ferramentas: [
            { id: cryptoRandom(), nome: 'Maca', qtd: 1, estado: 'ok' },
            { id: cryptoRandom(), nome: 'Extintor 6kg', qtd: 2, estado: 'ok' },
            { id: cryptoRandom(), nome: 'Lanterna', qtd: 3, estado: 'danificado' }
          ],
          checklists: []
        },
        { id: cryptoRandom(), nome: 'ABSC 02', tipo: 'ligeira', matricula: 'BB-11-BB', estado: 'operacional', ferramentas: [], checklists: [] },
        { id: cryptoRandom(), nome: 'VTU 03', tipo: 'ligeira', matricula: 'CC-22-CC', estado: 'inoperacional', ferramentas: [], checklists: [] }
      ],
      aricas: [
        { id: cryptoRandom(), nome: 'ARICA Norte', local: 'Parque A', estado: 'operacional', bar: '', provaH: '', validade: '' },
        { id: cryptoRandom(), nome: 'ARICA Sul',   local: 'Parque B', estado: 'operacional', bar: '', provaH: '', validade: '' }
      ],
      planeamento: [
        { id: cryptoRandom(), texto: 'Verificação mensal dos extintores', estado: 'por_realizar', createdAt: Date.now() }
      ]
    };

    function loadDB() { try { return JSON.parse(localStorage.getItem(DB_KEY)) || dbDefault; } catch { return dbDefault; } }
    function _localSaveDB() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); } // base
    function cryptoRandom() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    let DB = loadDB();
    if (!DB.planeamento) DB.planeamento = []; // normalizar versões antigas

    // =============================================================
    // ===================== NAVEGAÇÃO ENTRE VISTAS =================
    // =============================================================
    const sections = {
      home: document.getElementById('view-home'),
      viaturas: document.getElementById('view-viaturas'),
      viatura: document.getElementById('view-viatura'),
      aricas: document.getElementById('view-aricas'),
      planeamento: document.getElementById('view-planeamento'),
      print: document.getElementById('print-section'),
    };

    document.querySelectorAll('[data-view]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        goView(el.getAttribute('data-view'));
      });
    });

    function goView(name) {
      Object.values(sections).forEach(s => s.classList.add('d-none'));
      const target = sections[name];
      if (target) target.classList.remove('d-none');
      if (name === 'viaturas') renderViaturas();
      if (name === 'viatura')  { renderFerramentas(); renderChecklists(); }
      if (name === 'aricas')   renderAricas();
      if (name === 'planeamento') renderPlaneamento();
      if (name === 'home')     renderKPIs();
    }

    // =============================================================
    // ====================== RENDER – HOME/KPIs ====================
    // =============================================================
    function renderKPIs() {
      const total = DB.viaturas.length;
      const oper = DB.viaturas.filter(v => v.estado === 'operacional').length;
      const inop = DB.viaturas.filter(v => v.estado === 'inoperacional').length;
      const aricas = DB.aricas.length;

      const allFerr = DB.viaturas.flatMap(v => v.ferramentas || []);
      const ferrTotal = allFerr.length;
      const ferrOK = allFerr.filter(f => f.estado === 'ok').length;
      const ferrFalta = allFerr.filter(f => f.estado === 'falta').length;
      const ferrDan = allFerr.filter(f => f.estado === 'danificado').length;

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiOper').textContent = oper;
      document.getElementById('kpiInop').textContent = inop;
      document.getElementById('kpiAricas').textContent = aricas;
      const byId = id => document.getElementById(id);
      byId('kpiFerrTotal').textContent = ferrTotal;
      byId('kpiFerrOK').textContent = ferrOK;
      byId('kpiFerrFalta').textContent = ferrFalta;
      byId('kpiFerrDan').textContent = ferrDan;
    }

    // =============================================================
    // ====================== RENDER – VIATURAS =====================
    // =============================================================
    const gridViaturas = document.getElementById('gridViaturas');
    const searchViaturas = document.getElementById('searchViaturas');

    searchViaturas?.addEventListener('input', () => renderViaturas());

    function renderViaturas() {
      const q = (searchViaturas?.value || '').toLowerCase();
      gridViaturas.innerHTML = '';

      const list = DB.viaturas
        .filter(v => (v.nome + ' ' + v.matricula).toLowerCase().includes(q))
        .sort((a, b) => a.nome.localeCompare(b.nome));

      if (!list.length) {
        gridViaturas.innerHTML = '<div class="col"><div class="alert alert-secondary">Sem resultados.</div></div>';
        return;
      }

      list.forEach(v => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-lg-4';
        col.innerHTML = `
          <div class="soft-card p-3 h-100 d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <h3 class="h5 mb-1">${v.nome}</h3>
                <div class="text-secondary small">Matrícula: <strong>${v.matricula || '—'}</strong></div>
              </div>
              <span class="badge ${v.tipo === 'pesada' ? 'badge-heavy-type' : 'badge-light-type'} text-uppercase">${v.tipo}</span>
            </div>
            <div class="mt-2">
              <span class="badge ${v.estado === 'operacional' ? 'bg-success' : 'bg-danger'}">${v.estado}</span>
            </div>
            <div class="mt-auto pt-3 d-flex gap-2">
              <button class="btn btn-primary flex-grow-1" data-action="open" data-id="${v.id}">Abrir</button>
              <button class="btn btn-outline-secondary" data-action="edit" data-id="${v.id}">Editar</button>
              <button class="btn btn-outline-danger" data-action="delete" data-id="${v.id}">Apagar</button>
            </div>
          </div>`;
        gridViaturas.appendChild(col);
      });

      gridViaturas.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', handleViaturaAction);
      });
    }

    function handleViaturaAction(e) {
      const id = e.currentTarget.getAttribute('data-id');
      const action = e.currentTarget.getAttribute('data-action');
      const v = DB.viaturas.find(x => x.id === id);
      if (!v) return;
      if (action === 'open') openViatura(v);
      if (action === 'edit') openFormViatura(v);
      if (action === 'delete') confirmDelete(() => {
        DB.viaturas = DB.viaturas.filter(x => x.id !== id);
        saveDB(); renderViaturas(); renderKPIs();
      }, `Apagar a viatura <strong>${v.nome}</strong>?`);
    }

    // =============================================================
    // ====================== FORM – VIATURA ========================
    // =============================================================
    document.getElementById('btnAddViatura')?.addEventListener('click', () => openFormViatura());

    function openFormViatura(v = null) {
      const isEdit = !!v;
      const title = isEdit ? 'Editar Viatura' : 'Adicionar Viatura';
      injectFormFields([
        { label: 'Nome', name: 'nome', type: 'text', required: true, value: v?.nome || '' },
        { label: 'Matrícula', name: 'matricula', type: 'text', value: v?.matricula || '' },
        { label: 'Tipo', name: 'tipo', type: 'select', options: [
          { value: 'ligeira', label: 'Ligeira' },
          { value: 'pesada', label: 'Pesada' }], value: v?.tipo || 'ligeira' },
        { label: 'Estado', name: 'estado', type: 'select', options: [
          { value: 'operacional', label: 'Operacional' },
          { value: 'inoperacional', label: 'Inoperacional' }], value: v?.estado || 'operacional' },
      ], title, (formData) => {
        if (isEdit) { Object.assign(v, formData); }
        else { DB.viaturas.push({ id: cryptoRandom(), ferramentas: [], checklists: [], ...formData }); }
        saveDB(); renderViaturas(); renderKPIs();
      });
    }

    // =============================================================
    // ====================== DETALHE – VIATURA =====================
    // =============================================================
    const detalheTitulo = document.getElementById('detalheTitulo');
    const detalheMeta   = document.getElementById('detalheMeta');
    const tbodyFerramentas = document.getElementById('tbodyFerramentas');
    const tbodyChecklists  = document.getElementById('tbodyChecklists');

    function todayISO() { const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }

    let viaturaAtual = null;

    // agrupamento
    let ferrGrouped = true;
    const expandedFerrGroups = new Set();
    document.getElementById('btnToggleGroupFerr')?.addEventListener('click', () => {
      ferrGrouped = !ferrGrouped;
      document.getElementById('btnToggleGroupFerr').textContent = ferrGrouped ? 'Desagrupar' : 'Agrupar';
      document.getElementById('fabGroupFerr').textContent = document.getElementById('btnToggleGroupFerr').textContent;
      renderFerramentas();
    });

    function openViatura(v) {
      viaturaAtual = v;
      detalheTitulo.textContent = v.nome;
      detalheMeta.textContent = `${v.tipo} • ${v.matricula || '—'}`;
      renderFerramentas();
      renderChecklists();
      goView('viatura');
      syncEstadoButtons();
      // sincroniza rótulo do agrupamento na actionbar mobile
      const grpLabel = document.getElementById('btnToggleGroupFerr')?.textContent || (ferrGrouped ? 'Desagrupar' : 'Agrupar');
      document.getElementById('fabGroupFerr').textContent = grpLabel;
    }

    function syncEstadoButtons() {
      document.getElementById('btnEstadoOper').classList.toggle('status-oper', viaturaAtual.estado === 'operacional');
      document.getElementById('btnEstadoInop').classList.toggle('status-inop', viaturaAtual.estado === 'inoperacional');
    }

    document.getElementById('btnEstadoOper')?.addEventListener('click', () => {
      if (!viaturaAtual) return;
      viaturaAtual.estado = 'operacional';
      saveDB(); syncEstadoButtons(); renderKPIs(); renderViaturas();
    });

    document.getElementById('btnEstadoInop')?.addEventListener('click', () => {
      if (!viaturaAtual) return;
      viaturaAtual.estado = 'inoperacional';
      saveDB(); syncEstadoButtons(); renderKPIs(); renderViaturas();
    });

    // ===== Ferramentas (agrupado/desagrupado) =====
    function renderFerramentas() {
      tbodyFerramentas.innerHTML = '';

      // modo não agrupado
      if (!ferrGrouped) {
        (viaturaAtual.ferramentas || []).forEach((f, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${f.nome}</td>
            <td>
              <div class="input-group input-group-sm" style="max-width: 140px;">
                <button class="btn btn-outline-secondary" data-fact="dec" data-id="${f.id}">−</button>
                <input class="form-control text-center" data-fact="qtd" data-id="${f.id}" type="number" min="0" value="${f.qtd}">
                <button class="btn btn-outline-secondary" data-fact="inc" data-id="${f.id}">+</button>
              </div>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn ${f.estado==='ok' ? 'btn-success' : 'btn-outline-success'}" data-fact="estado" data-value="ok" data-id="${f.id}">OK</button>
                <button class="btn ${f.estado==='falta' ? 'btn-danger' : 'btn-outline-danger'}" data-fact="estado" data-value="falta" data-id="${f.id}">Falta</button>
                <button class="btn ${f.estado==='danificado' ? 'btn-warning' : 'btn-outline-warning'}" data-fact="estado" data-value="danificado" data-id="${f.id}">Danificado</button>
              </div>
            </td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" data-fact="edit" data-id="${f.id}">Editar</button>
                <button class="btn btn-outline-danger btn-sm" data-fact="del" data-id="${f.id}">Remover</button>
              </div>
            </td>`;
          tbodyFerramentas.appendChild(tr);
        });

        bindFerramentaRowEvents();
        return;
      }

      // modo agrupado
      const map = {};
      (viaturaAtual.ferramentas || []).forEach(f => {
        const key = (f.nome || '(sem nome)').trim();
        const g = map[key] || (map[key] = { nome: key, items: [], ok: 0, falta: 0, danificado: 0, total: 0 });
        g.items.push(f);
        const q = Number(f.qtd) || 0;
        g.total += q;
        if (f.estado === 'ok') g.ok += q;
        else if (f.estado === 'falta') g.falta += q;
        else if (f.estado === 'danificado') g.danificado += q;
      });
      const groups = Object.values(map).sort((a, b) => a.nome.localeCompare(b.nome));

      let counter = 0;
      groups.forEach(g => {
        const opened = expandedFerrGroups.has(g.nome);

        const trHead = document.createElement('tr');
        trHead.className = 'table-active';
        trHead.innerHTML = `
          <td colspan="5">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-3">
                <button class="btn btn-sm btn-outline-secondary" data-group-toggle="${g.nome}">${opened ? '−' : '+'}</button>
                <strong>${g.nome}</strong>
                <span class="badge bg-success">OK ${g.ok}</span>
                <span class="badge bg-danger ms-1">Falta ${g.falta}</span>
                <span class="badge bg-warning text-dark ms-1">Danificado ${g.danificado}</span>
                <span class="text-secondary ms-2">Total ${g.total}</span>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" data-group-add="${g.nome}">Adicionar</button>
              </div>
            </div>
          </td>`;
        tbodyFerramentas.appendChild(trHead);

        if (opened) {
          g.items.forEach((f) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${++counter}</td>
              <td class="text-secondary">${f.nome}</td>
              <td>
                <div class="input-group input-group-sm" style="max-width: 140px;">
                  <button class="btn btn-outline-secondary" data-fact="dec" data-id="${f.id}">−</button>
                  <input class="form-control text-center" data-fact="qtd" data-id="${f.id}" type="number" min="0" value="${f.qtd}">
                  <button class="btn btn-outline-secondary" data-fact="inc" data-id="${f.id}">+</button>
                </div>
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn ${f.estado==='ok' ? 'btn-success' : 'btn-outline-success'}" data-fact="estado" data-value="ok" data-id="${f.id}">OK</button>
                  <button class="btn ${f.estado==='falta' ? 'btn-danger' : 'btn-outline-danger'}" data-fact="estado" data-value="falta" data-id="${f.id}">Falta</button>
                  <button class="btn ${f.estado==='danificado' ? 'btn-warning' : 'btn-outline-warning'}" data-fact="estado" data-value="danificado" data-id="${f.id}">Danificado</button>
                </div>
              </td>
              <td>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" data-fact="edit" data-id="${f.id}">Editar</button>
                  <button class="btn btn-outline-danger btn-sm" data-fact="del" data-id="${f.id}">Remover</button>
                </div>
              </td>`;
            tbodyFerramentas.appendChild(tr);
          });
        }
      });

      // eventos grupo
      tbodyFerramentas.querySelectorAll('[data-group-toggle]').forEach(b => {
        b.addEventListener('click', (e) => {
          const key = e.currentTarget.getAttribute('data-group-toggle');
          if (expandedFerrGroups.has(key)) expandedFerrGroups.delete(key);
          else expandedFerrGroups.add(key);
          renderFerramentas();
        });
      });
      tbodyFerramentas.querySelectorAll('[data-group-add]').forEach(b => {
        b.addEventListener('click', (e) => {
          const nome = e.currentTarget.getAttribute('data-group-add');
          openFormFerramenta(null, nome);
        });
      });

      bindFerramentaRowEvents();
    }

    function bindFerramentaRowEvents() {
      tbodyFerramentas.querySelectorAll('[data-fact]').forEach(b => b.addEventListener('click', handleFerramentaAction));
      tbodyFerramentas.querySelectorAll('input[data-fact="qtd"]').forEach(inp => {
        inp.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          const f = viaturaAtual.ferramentas.find(x => x.id === id);
          f.qtd = Math.max(0, parseInt(e.target.value || '0', 10));
          saveDB();
        });
      });
    }

    function handleFerramentaAction(e) {
      const el = e.currentTarget;
      const id = el.getAttribute('data-id');
      const act = el.getAttribute('data-fact');
      const f = viaturaAtual.ferramentas.find(x => x.id === id);
      if (!f && act !== 'add') return;

      if (act === 'inc') { f.qtd++; saveDB(); renderFerramentas(); renderKPIs(); return; }
      if (act === 'dec') { f.qtd = Math.max(0, f.qtd - 1); saveDB(); renderFerramentas(); renderKPIs(); return; }
      if (act === 'estado') { f.estado = el.getAttribute('data-value'); saveDB(); renderFerramentas(); renderKPIs(); return; }
      if (act === 'edit') { openFormFerramenta(f); return; }
      if (act === 'del') {
        confirmDelete(() => {
          viaturaAtual.ferramentas = viaturaAtual.ferramentas.filter(x => x.id !== id);
          saveDB(); renderFerramentas(); renderKPIs();
        }, `Remover a ferramenta <strong>${f?.nome || ''}</strong>?`);
        return;
      }
    }

    document.getElementById('btnAddFerramenta')?.addEventListener('click', () => openFormFerramenta());
    document.getElementById('fabAddFerr')?.addEventListener('click', () => document.getElementById('btnAddFerramenta').click());
    document.getElementById('fabExportFerr')?.addEventListener('click', () => document.getElementById('btnExportFerramentas').click());
    document.getElementById('fabGroupFerr')?.addEventListener('click', () => document.getElementById('btnToggleGroupFerr').click());

    function openFormFerramenta(f = null, defaultNome = '') {
      const isEdit = !!f;
      const title = isEdit ? 'Editar Ferramenta' : 'Adicionar Ferramenta';
      injectFormFields([
        { label: 'Nome', name: 'nome', type: 'text', required: true, value: f?.nome || defaultNome },
        { label: 'Quantidade', name: 'qtd', type: 'number', min: 0, value: f?.qtd ?? 1 },
        { label: 'Estado', name: 'estado', type: 'select', options: [
          { value: 'ok',         label: 'OK' },
          { value: 'falta',      label: 'Falta' },
          { value: 'danificado', label: 'Danificado' }], value: f?.estado || 'ok' },
      ], title, (formData) => {
        formData.qtd = Math.max(0, parseInt(formData.qtd || '0', 10));
        if (isEdit) { Object.assign(f, formData); }
        else { (viaturaAtual.ferramentas || (viaturaAtual.ferramentas = [])).push({ id: cryptoRandom(), ...formData }); }
        saveDB(); renderFerramentas(); renderKPIs();
      });
    }

    // ====================== CHECKLISTS ======================
    function resumoFerramentas(list) {
      const res = { ok: 0, falta: 0, danificado: 0, total: 0, byName: {} };
      (list || []).forEach(f => {
        const q = Number(f.qtd) || 0;
        res.total += q;
        if (f.estado === 'ok') res.ok += q;
        else if (f.estado === 'falta') res.falta += q;
        else if (f.estado === 'danificado') res.danificado += q;

        const n = (f.nome || '(sem nome)').trim();
        const g = res.byName[n] || (res.byName[n] = { ok: 0, falta: 0, danificado: 0, total: 0 });
        g.total += q;
        if (f.estado === 'ok') g.ok += q;
        else if (f.estado === 'falta') g.falta += q;
        else if (f.estado === 'danificado') g.danificado += q;
      });
      return res;
    }

    function renderChecklists() {
      tbodyChecklists.innerHTML = '';
      const list = (viaturaAtual.checklists || []).slice().sort((a, b) => (b.data || '').localeCompare(a.data || ''));

      list.forEach((c) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.data || '—'}</td>
          <td>${c.kms ?? '—'}</td>
          <td><span class="badge ${c.limpo ? 'bg-success' : 'bg-danger'}">${c.limpo ? 'Sim' : 'Não'}</span></td>
          <td>${(c.equipa || '—').replace(/</g,'&lt;')}</td>
          <td>
            ${c.toolsSummary ? `
              <span class="badge bg-success">OK ${c.toolsSummary.ok}</span>
              <span class="badge bg-danger ms-1">Falta ${c.toolsSummary.falta}</span>
              <span class="badge bg-warning text-dark ms-1">Danif. ${c.toolsSummary.danificado}</span>
              <span class="text-secondary ms-1">Tot. ${c.toolsSummary.total}</span>
            ` : '<span class="text-secondary">—</span>'}
          </td>
          <td>${c.obs ? c.obs.replace(/</g,'&lt;') : ''}</td>
          <td>
            <div class="d-flex flex-wrap gap-2">
              ${c.tools ? '<button class="btn btn-outline-primary btn-sm" data-chk="viewtools" data-id="'+c.id+'">Ver</button>' : ''}
              <button class="btn btn-outline-secondary btn-sm" data-chk="edit" data-id="${c.id}">Editar</button>
              <button class="btn btn-outline-danger btn-sm" data-chk="del" data-id="${c.id}">Remover</button>
            </div>
          </td>`;
        tbodyChecklists.appendChild(tr);
      });

      tbodyChecklists.querySelectorAll('[data-chk]').forEach(b => b.addEventListener('click', handleChecklistAction));
    }

    function handleChecklistAction(e) {
      const id = e.currentTarget.getAttribute('data-id');
      const act = e.currentTarget.getAttribute('data-chk');
      const list = viaturaAtual.checklists || (viaturaAtual.checklists = []);
      const c = list.find(x => x.id === id);

      if (act === 'edit' && c) return openFormChecklist(c);
      if (act === 'viewtools' && c?.tools) return openChecklistTools(c);

      if (act === 'del' && c) {
        confirmDelete(() => {
          viaturaAtual.checklists = list.filter(x => x.id !== id);
          saveDB(); renderChecklists();
        }, `Remover o registo de <strong>${c.data}</strong>?`);
      }
    }

    document.getElementById('btnAddChecklist')?.addEventListener('click', () => openFormChecklist());

    function openFormChecklist(c = null) {
      const isEdit = !!c;
      const title = isEdit ? 'Editar registo diário' : 'Novo registo diário';
      const lastKms = (viaturaAtual.checklists || []).slice().sort((a,b)=>(b.data||'').localeCompare(a.data||''))[0]?.kms ?? '';

      injectFormFields([
        { label: 'Data', name: 'data', type: 'date', required: true, value: c?.data || todayISO() },
        { label: 'Kms', name: 'kms', type: 'number', min: 0, value: c?.kms ?? lastKms },
        { label: 'Limpeza', name: 'limpo', type: 'select', options: [
          { value: 'sim', label: 'Limpo' },
          { value: 'nao', label: 'Sujo' }], value: c?.limpo ? 'sim' : 'nao' },
        { label: 'Equipa', name: 'equipa', type: 'select', options: [
          { value: 'EIP 1', label: 'EIP 1' },
          { value: 'EIP 2', label: 'EIP 2' }], value: c?.equipa || 'EIP 1' },
        { label: 'Anexar análise das ferramentas de hoje', name: 'anexarFerr', type: 'select', options: [
          { value: 'sim', label: 'Sim' },
          { value: 'nao', label: 'Não' }
        ], value: 'sim' },
        { label: 'Observações', name: 'obs', type: 'text', value: c?.obs || '' },
      ], title, (formData) => {
        const anexar = formData.anexarFerr === 'sim';
        let toolsSummary = null, tools = null;
        if (anexar) {
          tools = (viaturaAtual.ferramentas || []).map(f => ({ nome: f.nome, qtd: Number(f.qtd) || 0, estado: f.estado }));
          toolsSummary = resumoFerramentas(viaturaAtual.ferramentas || []);
        }
        const payload = {
          id: c?.id || cryptoRandom(),
          data: formData.data || todayISO(),
          kms: Math.max(0, parseInt(formData.kms || '0', 10)),
          limpo: formData.limpo === 'sim',
          equipa: formData.equipa || 'EIP 1',
          obs: (formData.obs || '').trim(),
          toolsSummary,
          tools
        };
        if (isEdit) Object.assign(c, payload);
        else (viaturaAtual.checklists || (viaturaAtual.checklists = [])).push(payload);
        saveDB(); renderChecklists();
      });
    }

    function openChecklistTools(c) {
      const sum = c.toolsSummary || resumoFerramentas(c.tools || []);
      const rows = (c.tools || []).map(t =>
        `<tr><td>${(t.nome||'').replace(/</g,'&lt;')}</td><td class="text-center">${t.qtd}</td><td>${t.estado}</td></tr>`
      ).join('') || '<tr><td colspan="3" class="text-secondary">Sem registos.</td></tr>';

      const html = `
        <div class="col-12">
          <div class="mb-2">
            <span class="badge bg-success">OK ${sum.ok}</span>
            <span class="badge bg-danger ms-1">Falta ${sum.falta}</span>
            <span class="badge bg-warning text-dark ms-1">Danificado ${sum.danificado}</span>
            <span class="text-secondary ms-2">Total ${sum.total}</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light"><tr><th>Ferramenta</th><th style="width:90px;" class="text-center">Qtd</th><th style="width:140px;">Estado</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;

      const titleEl = document.getElementById('modalFormTitle');
      const form = document.getElementById('formGeneric');
      const saveBtn = document.getElementById('modalSave');

      titleEl.textContent = `Ferramentas — ${c.data || ''}`;
      form.innerHTML = html;
      const oldText = saveBtn.textContent;
      const handler = () => { modalForm.hide(); saveBtn.removeEventListener('click', handler); saveBtn.textContent = oldText; };
      saveBtn.textContent = 'Fechar';
      saveBtn.addEventListener('click', handler);
      modalForm.show();
    }

    // =============================================================
    // ========================= ARICAS ============================
    // =============================================================
    const tbodyAricas = document.getElementById('tbodyAricas');

    function renderAricas() {
      tbodyAricas.innerHTML = '';
      const hoje = new Date();

      DB.aricas.forEach((a, i) => {
        const daysLeft = a.validade ? Math.ceil((new Date(a.validade) - hoje) / 86400000) : null;
        let badge = '';
        if (daysLeft !== null) {
          if (daysLeft < 0) badge = '<span class="badge text-bg-danger ms-2">Expirada</span>';
          else if (daysLeft <= 30) badge = '<span class="badge text-bg-warning ms-2">A expirar</span>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${a.nome}</td>
          <td>${a.local}</td>
          <td class="d-none d-md-table-cell">
            <input type="date" class="form-control form-control-sm" value="${a.provaH || ''}" data-arica="provaH" data-id="${a.id}">
          </td>
          <td class="d-none d-md-table-cell">
            <div class="d-flex align-items-center">
              <input type="date" class="form-control form-control-sm" value="${a.validade || ''}" data-arica="validade" data-id="${a.id}">
              ${badge}
            </div>
          </td>
          <td>
            <select class="form-select form-select-sm" data-arica="estado" data-id="${a.id}">
              <option value="operacional" ${a.estado==='operacional'?'selected':''}>Operacional</option>
              <option value="inoperacional" ${a.estado==='inoperacional'?'selected':''}>Inoperacional</option>
            </select>
          </td>
          <td>
            <input type="text" class="form-control form-control-sm" placeholder="BAR" value="${a.bar||''}" data-arica="bar" data-id="${a.id}">
          </td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" data-arica="edit" data-id="${a.id}">Editar</button>
              <button class="btn btn-outline-danger btn-sm" data-arica="del" data-id="${a.id}">Remover</button>
            </div>
          </td>`;
        tbodyAricas.appendChild(tr);
      });

      tbodyAricas.querySelectorAll('[data-arica="edit"], [data-arica="del"]').forEach(b => b.addEventListener('click', handleAricaAction));

      tbodyAricas.querySelectorAll('select[data-arica="estado"]').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          const a = DB.aricas.find(x => x.id === id);
          if (!a) return;
          a.estado = e.target.value;
          saveDB(); renderKPIs();
        });
      });

      tbodyAricas.querySelectorAll('input[data-arica="provaH"], input[data-arica="validade"]').forEach(inp => {
        inp.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          const key = e.target.dataset.arica;
          const a = DB.aricas.find(x => x.id === id);
          if (!a) return;
          a[key] = e.target.value;
          saveDB(); renderAricas();
        });
      });

      const saveBAR = (e) => {
        const id = e.target.dataset.id;
        const a = DB.aricas.find(x => x.id === id);
        if (!a) return;
        a.bar = e.target.value;
        saveDB();
      };
      tbodyAricas.querySelectorAll('input[data-arica="bar"]').forEach(inp => {
        inp.addEventListener('change', saveBAR);
        inp.addEventListener('blur', saveBAR);
      });
    }

    document.getElementById('btnAddArica')?.addEventListener('click', () => openFormArica());

    function handleAricaAction(e) {
      const id = e.currentTarget.getAttribute('data-id');
      const act = e.currentTarget.getAttribute('data-arica');
      const a = DB.aricas.find(x => x.id === id);
      if (!a) return;
      if (act === 'edit') return openFormArica(a);
      if (act === 'del') return confirmDelete(() => {
        DB.aricas = DB.aricas.filter(x => x.id !== id);
        saveDB(); renderAricas(); renderKPIs();
      }, `Remover a ARICA <strong>${a.nome}</strong>?`);
    }

    function openFormArica(a = null) {
      const isEdit = !!a;
      const title = isEdit ? 'Editar ARICA' : 'Adicionar ARICA';
      injectFormFields([
        { label: 'Designação', name: 'nome', type: 'text', required: true, value: a?.nome || '' },
        { label: 'Localização', name: 'local', type: 'text', value: a?.local || '' },
        { label: 'Estado', name: 'estado', type: 'select', options: [
          { value: 'operacional', label: 'Operacional' },
          { value: 'inoperacional', label: 'Inoperacional' }], value: a?.estado || 'operacional' },
        { label: 'Data de prova hidráulica', name: 'provaH', type: 'date', value: a?.provaH || '' },
        { label: 'Data de validade',        name: 'validade', type: 'date', value: a?.validade || '' },
        { label: 'BAR', name: 'bar', type: 'text', value: a?.bar || '' },
      ], title, (formData) => {
        if (isEdit) { Object.assign(a, formData); }
        else { DB.aricas.push({ id: cryptoRandom(), ...formData }); }
        saveDB(); renderAricas(); renderKPIs();
      });
    }

    // =============================================================
    // ====================== PLANEAMENTO ===========================
    // =============================================================
    const tbodyPlaneamento = document.getElementById('tbodyPlaneamento');
    const searchPlaneamento = document.getElementById('searchPlaneamento');

    searchPlaneamento?.addEventListener('input', () => renderPlaneamento());
    document.getElementById('btnAddPlano')?.addEventListener('click', () => openFormPlano());

    function renderPlaneamento() {
      if (!tbodyPlaneamento) return;
      tbodyPlaneamento.innerHTML = '';

      const q = (searchPlaneamento?.value || '').toLowerCase().trim();
      const list = (DB.planeamento || [])
        .filter(p => (p.texto || '').toLowerCase().includes(q))
        .sort((a,b) => (b.createdAt||0) - (a.createdAt||0));

      if (!list.length) {
        tbodyPlaneamento.innerHTML = '<tr><td colspan="4" class="text-secondary p-3">Sem registos.</td></tr>';
        return;
      }

      list.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${(p.texto || '').replace(/</g,'&lt;')}</td>
          <td>
            <select class="form-select form-select-sm" data-plan="estado" data-id="${p.id}">
              <option value="por_realizar" ${p.estado==='por_realizar'?'selected':''}>Por realizar</option>
              <option value="realizado" ${p.estado==='realizado'?'selected':''}>Realizado</option>
            </select>
          </td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" data-plan="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-outline-danger btn-sm" data-plan="del" data-id="${p.id}">Remover</button>
            </div>
          </td>`;
        tbodyPlaneamento.appendChild(tr);
      });

      tbodyPlaneamento.querySelectorAll('select[data-plan="estado"]').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          const item = DB.planeamento.find(x => x.id === id);
          if (!item) return;
          item.estado = e.target.value;
          saveDB();
        });
      });

      tbodyPlaneamento.querySelectorAll('[data-plan="edit"], [data-plan="del"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          const act = e.currentTarget.dataset.plan;
          const item = DB.planeamento.find(x => x.id === id);
          if (!item) return;

          if (act === 'edit') return openFormPlano(item);
          if (act === 'del') {
            confirmDelete(() => {
              DB.planeamento = DB.planeamento.filter(x => x.id !== id);
              saveDB(); renderPlaneamento();
            }, `Remover o registo de planeamento?`);
          }
        });
      });
    }

    function openFormPlano(p = null) {
      const isEdit = !!p;
      const title = isEdit ? 'Editar registo de planeamento' : 'Novo registo de planeamento';
      injectFormFields([
        { label: 'Observação', name: 'texto', type: 'textarea', rows: 5, required: true, value: p?.texto || '' },
        { label: 'Estado', name: 'estado', type: 'select', options: [
          { value: 'por_realizar', label: 'Por realizar' },
          { value: 'realizado',    label: 'Realizado' }], value: p?.estado || 'por_realizar' },
      ], title, (formData) => {
        if (isEdit) {
          Object.assign(p, { texto: formData.texto, estado: formData.estado });
        } else {
          DB.planeamento.push({
            id: cryptoRandom(),
            texto: formData.texto,
            estado: formData.estado || 'por_realizar',
            createdAt: Date.now()
          });
        }
        saveDB(); renderPlaneamento();
      });
    }

    document.getElementById('btnExportPlaneamento')?.addEventListener('click', () => {
      const rows = (DB.planeamento || []).map((p, i) => ({
        N: i + 1,
        Observacao: p.texto || '',
        Estado: p.estado || 'por_realizar'
      }));
      exportSheet(rows, 'planeamento.xlsx', 'Planeamento');
    });

    // =============================================================
    // ==================== EXPORTAR / IMPRIMIR =====================
    // =============================================================
    document.getElementById('btnExportViaturas')?.addEventListener('click', () => {
      const rowsV = DB.viaturas.map(v => ({ Nome: v.nome, Tipo: v.tipo, Matricula: v.matricula, Estado: v.estado }));
      const rowsF = DB.viaturas.flatMap(v => (v.ferramentas || []).map(f => ({ Viatura: v.nome, Matricula: v.matricula, Ferramenta: f.nome, Qtd: f.qtd, Estado: f.estado })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsV), 'Viaturas');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsF), 'Ferramentas');
      XLSX.writeFile(wb, 'viaturas.xlsx');
    });

    document.getElementById('btnExportFerramentas')?.addEventListener('click', () => {
      if (!viaturaAtual) return;
      const rows = (viaturaAtual.ferramentas || []).map(f => ({ Viatura: viaturaAtual.nome, Ferramenta: f.nome, Qtd: f.qtd, Estado: f.estado }));
      exportSheet(rows, `${viaturaAtual.nome}-ferramentas.xlsx`, 'Ferramentas');
    });

    document.getElementById('btnExportChecklists')?.addEventListener('click', () => {
      if (!viaturaAtual) return;
      const rows = (viaturaAtual.checklists || []).map(c => ({
        Viatura: viaturaAtual.nome,
        Data: c.data || '',
        Kms: c.kms ?? '',
        Limpo: c.limpo ? 'Sim' : 'Não',
        Equipa: c.equipa || '',
        OK: c.toolsSummary?.ok ?? '',
        Falta: c.toolsSummary?.falta ?? '',
        Danificado: c.toolsSummary?.danificado ?? '',
        Total: c.toolsSummary?.total ?? '',
        Observacoes: c.obs || ''
      }));
      exportSheet(rows, `${viaturaAtual.nome}-checklists.xlsx`, 'Checklists');
    });

    document.getElementById('btnExportAricas')?.addEventListener('click', () => {
      const rows = DB.aricas.map(a => ({
        Designacao: a.nome,
        Localizacao: a.local,
        Estado: a.estado || '',
        BAR: a.bar || '',
        Prova_Hidraulica: a.provaH || '',
        Validade: a.validade || ''
      }));
      exportSheet(rows, 'aricas.xlsx', 'ARICAS');
    });

    document.getElementById('btnPrint')?.addEventListener('click', () => {
      const ps = sections.print; ps.innerHTML = '';
      const clone = document.querySelector('main section:not(.d-none)')?.cloneNode(true) || document.querySelector('main').cloneNode(true);
      ps.appendChild(clone); ps.classList.remove('d-none'); window.print(); ps.classList.add('d-none'); ps.innerHTML = '';
    });

    function exportSheet(rows, filename, sheetName) {
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      XLSX.writeFile(wb, filename);
    }

    // =============================================================
    // =============== MODAIS (FORM & CONFIRMAÇÃO) =================
    // =============================================================
    const modalForm = new bootstrap.Modal(document.getElementById('modalForm'));
    const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirm'));

    function injectFormFields(fields, title, onSave) {
      document.getElementById('modalFormTitle').textContent = title;
      const form = document.getElementById('formGeneric'); form.innerHTML = '';
      fields.forEach(f => {
        const id = cryptoRandom(); const col = document.createElement('div'); col.className = 'col-12';
        if (f.type === 'select') {
          col.innerHTML = `
            <label class="form-label" for="${id}">${f.label}</label>
            <select class="form-select" id="${id}" name="${f.name}" ${f.required ? 'required' : ''}>
              ${f.options.map(o => `<option value="${o.value}" ${o.value===f.value?'selected':''}>${o.label}</option>`).join('')}
            </select>`;
        } else if (f.type === 'textarea') {
          col.innerHTML = `
            <label class="form-label" for="${id}">${f.label}</label>
            <textarea class="form-control" id="${id}" name="${f.name}" rows="${f.rows||4}" ${f.required ? 'required' : ''}>${f.value??''}</textarea>`;
        } else {
          col.innerHTML = `
            <label class="form-label" for="${id}">${f.label}</label>
            <input class="form-control" id="${id}" name="${f.name}" type="${f.type||'text'}" value="${f.value??''}" ${f.required ? 'required' : ''} ${f.min!=null?`min="${f.min}"`:''}/>`;
        }
        form.appendChild(col);
      });

      const saveBtn = document.getElementById('modalSave');
      const handler = () => { const data = Object.fromEntries(new FormData(form).entries()); onSave(data); modalForm.hide(); saveBtn.removeEventListener('click', handler); };
      saveBtn.addEventListener('click', handler); modalForm.show();
    }

    function confirmDelete(onYes, message = 'Tens a certeza?') {
      document.getElementById('modalConfirmMsg').innerHTML = message;
      const yesBtn = document.getElementById('modalConfirmYes');
      const handler = () => { onYes(); modalConfirm.hide(); yesBtn.removeEventListener('click', handler); };
      yesBtn.addEventListener('click', handler); modalConfirm.show();
    }

    // =============================================================
    // ====================== FIREBASE – AUTO SYNC ==================
    // =============================================================
    // TODO: Substitui pelos teus valores (Project Settings → Web app)
    const firebaseConfig = {
  apiKey: "AIzaSyDuRdYhcWm2QWsyN0_zn6XAlWUCZw80GlM",
  authDomain: "eip-checklist.firebaseapp.com",
  projectId: "eip-checklist",
  storageBucket: "eip-checklist.firebasestorage.app",
  messagingSenderId: "128008865777",
  appId: "1:128008865777:web:49a07b2052887f50992650",
  measurementId: "G-GHN66D8RDH"
};

    const ORG_ID = 'eip-corpo';                            // identifica a corporação
    const DEVICE_ID_KEY = 'eip_device_id_v1';
    const deviceId = localStorage.getItem(DEVICE_ID_KEY) || (localStorage.setItem(DEVICE_ID_KEY, cryptoRandom()), localStorage.getItem(DEVICE_ID_KEY));
    let fb = { app:null, auth:null, fs:null, user:null, orgRef:null, unsub:null };
    let cloudReady = false;
    let lastLocalSave = Date.now();
    let pushing = false;
    let cloudTimer = null;

    // sobrescreve saveDB para sincronizar também com a cloud (debounce)
    function saveDB() {
      _localSaveDB();
      lastLocalSave = Date.now();
      if (cloudTimer) clearTimeout(cloudTimer);
      cloudTimer = setTimeout(() => {
        if (cloudReady) pushCloud('save');
      }, 800);
    }

    async function initFirebaseSync() {
      try {
        fb.app = firebase.initializeApp(firebaseConfig);
        fb.auth = firebase.auth();
        fb.fs   = firebase.firestore();

        try { await fb.fs.enablePersistence({ synchronizeTabs: true }); } catch(e) { console.warn('Persistence off:', e.code); }

        await fb.auth.signInAnonymously();
        fb.user = fb.auth.currentUser;

        fb.orgRef = fb.fs.doc(`orgs/${ORG_ID}`);

        // Listener em tempo-real
        fb.unsub = fb.orgRef.onSnapshot(snap => {
          const data = snap.data();
          if (!data || !data.db) return;

          const remoteUpdated = data.updatedAt || 0;
          if (remoteUpdated > lastLocalSave && !pushing) {
            DB = data.db;
            _localSaveDB(); // persiste local sem novo push
            renderKPIs();
            // refresca a vista visível
            if (!sections.home.classList.contains('d-none')) renderKPIs();
            if (!sections.viaturas.classList.contains('d-none')) renderViaturas();
            if (!sections.viatura.classList.contains('d-none')) { renderFerramentas(); renderChecklists(); }
            if (!sections.aricas.classList.contains('d-none')) renderAricas();
            if (!sections.planeamento.classList.contains('d-none')) renderPlaneamento();
          }
        });

        // cria doc inicial se não existir
        const snap = await fb.orgRef.get();
        if (!snap.exists) await pushCloud('init');

        cloudReady = true;
      } catch (err) {
        console.error('Firebase init error:', err);
      }
    }

    async function pushCloud(tag = 'save') {
      if (!fb.orgRef) return;
      try {
        pushing = true;
        lastLocalSave = Date.now();
        await fb.orgRef.set({
          db: DB,
          updatedAt: lastLocalSave,
          by: deviceId,
          tag
        }, { merge: true });
      } finally {
        setTimeout(() => { pushing = false; }, 150);
      }
    }

    // =============================================================
    // ============================ INIT ============================
    // =============================================================
    renderKPIs();
    goView('home');
    initFirebaseSync();
  </script>
</body>
</html>
